version: '3.8'

services:
  # VictoriaMetrics - Time-series database for Prometheus metrics
  victoriametrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: hpc-victoriametrics
    command:
      - "-retentionPeriod=60d"
      - "-httpListenAddr=:8428"
    ports:
      - "9090:8428"
    volumes:
      - vm-data:/victoria-metrics-data
    networks:
      - hpc-monitoring-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8428/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MySQL - XDMoD database
  mysql:
    image: mysql:8.0
    container_name: hpc-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-modw}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "6033:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - hpc-monitoring-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_PASSWORD:-rootpassword}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend API - Node.js + Express
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: ${BUILD_TARGET:-development}
    container_name: hpc-backend
    env_file:
      - .env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      API_PORT: ${API_PORT:-3001}
      API_HOST: 0.0.0.0
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      PROMETHEUS_URL: http://victoriametrics:8428
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-modw}
    ports:
      - "${API_PORT:-3001}:3001"
    volumes:
      # Development: mount source code for hot-reload
      - ./backend:/app:delegated
      - backend-node-modules:/app/node_modules
      # Persistent storage
      - backend-cache:/app/cache
      - backend-logs:/app/logs
    depends_on:
      victoriametrics:
        condition: service_healthy
      mysql:
        condition: service_healthy
    networks:
      - hpc-monitoring-network
    restart: unless-stopped
    profiles:
      - dev
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Backend API - Production
  backend-prod:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: production
    container_name: hpc-backend
    env_file:
      - .env
    environment:
      NODE_ENV: production
      API_PORT: ${API_PORT:-3001}
      API_HOST: 0.0.0.0
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      PROMETHEUS_URL: http://victoriametrics:8428
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-modw}
    ports:
      - "${API_PORT:-3001}:3001"
    volumes:
      # Production: only persistent storage, no source code mount
      - backend-cache:/app/cache
      - backend-logs:/app/logs
    depends_on:
      victoriametrics:
        condition: service_healthy
      mysql:
        condition: service_healthy
    networks:
      - hpc-monitoring-network
    restart: unless-stopped
    profiles:
      - prod
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend - React + Vite
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: ${BUILD_TARGET:-development}
    container_name: hpc-frontend
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      VITE_API_URL: http://localhost:${API_PORT:-3001}
    ports:
      - "3000:3000"
    volumes:
      # Development: mount source code for hot-reload
      - ./:/app:delegated
      - frontend-node-modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - hpc-monitoring-network
    restart: unless-stopped
    profiles:
      - dev

  # Frontend - Production
  frontend-prod:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: production
    container_name: hpc-frontend
    environment:
      NODE_ENV: production
      VITE_API_URL: http://localhost:${API_PORT:-3001}
    ports:
      - "3000:3000"
    depends_on:
      - backend-prod
    networks:
      - hpc-monitoring-network
    restart: unless-stopped
    profiles:
      - prod

# Named volumes for persistent data
volumes:
  vm-data:
    name: hpc-victoriametrics-data
  mysql-data:
    name: hpc-mysql-data
  backend-cache:
    name: hpc-backend-cache
  backend-logs:
    name: hpc-backend-logs
  backend-node-modules:
    name: hpc-backend-node-modules
  frontend-node-modules:
    name: hpc-frontend-node-modules

# Network for inter-service communication
networks:
  hpc-monitoring-network:
    name: hpc-monitoring-network
    driver: bridge
